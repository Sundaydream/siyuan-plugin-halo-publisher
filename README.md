# 思源笔记 Halo 发布插件

一个强大的思源笔记插件，用于将您的笔记一键发布到 [Halo](https://halo.run) 博客平台。无需离开思源笔记，即可完成文章的发布、更新和管理。

## ⚠️ 免责声明

**本插件由 AI 辅助开发，未经过完整、严苛的测试。**
请在使用前务必备份您的重要数据。使用本插件产生的一切后果（包括但不限于数据丢失、内容格式错误等）由用户自行承担。

## ✨ 功能特性

- **一键发布**：直接利用 Halo Open API 将思源笔记内容发布为博客文章。
- **智能图片处理**：
  - 自动提取并上传笔记中的图片到 Halo 图库。
  - **自动去重**：已上传的图片不会重复上传，节省服务器空间。
  - **封面图同步**：支持同步思源笔记的 `title-img` 属性作为文章封面，并自动从正文中移除该图以避免重复显示。
- **文章管理闭环**：
  - 支持发布新文章。
  - 支持**更新**已发布的文章（内容、标题、元数据）。
  - 支持**关联删除**：在 Halo 端删除文章后，插件内支持同步标记为“已删除”并清理本地关联记录。
- **元数据管理**：支持从插件界面直接选择或新建 Halo 的**分类**和**标签**。
- **便捷登录**：提供“自动获取 Cookie”功能，通过弹窗登录自动抓取认证信息，无需手动复制（也支持手动模式）。
- **完全兼容**：适配思源笔记的 Markdown 和挂件机制。

## 📖 用户使用指南

### 1. 安装插件
1. 下载最新的 `package.zip` 或发布的构建包。
2. 在思源笔记中打开 **设置** -> **关于**，找到 **工作空间路径**。
3. 进入 `data/plugins` 目录，新建文件夹 `siyuan-halo-publisher`。
4. 将解压后的文件放入该文件夹中。
5. 重启思源笔记，在顶栏或右键菜单中启用插件。

### 2. 配置连接
1. 点击顶栏的 Halo 图标打开插件界面。
2. 进入 **通用设置** 标签页。
3. **Halo 网站 URL**：输入您的博客地址（例如 `https://your-blog.com`）。
4. **获取授权**：
   - **方式 A（推荐）**：点击 **"🔐 自动登录获取 Cookie"** 下方的按钮，在弹出的窗口中登录您的 Halo 后台。登录成功后关闭窗口，插件会自动填充 Cookie。
   - **方式 B（手动）**：登录 Halo 后台，按 F12 打开开发者工具，在网络请求中找到 Cookie 并手动粘贴到输入框。
5. 点击 **保存并验证**，看到“授权有效”即表示配置成功。

### 3. 发布文章
1. 打开一篇思源笔记。
2. 打开插件界面，切换到 **文章发布** 标签页。
3. 插件会自动读取当前笔记的标题和内容。
4. 设置 **分类** 和 **标签**（支持直接新建）。
5. 点击 **发布到 Halo**。
   - 首次发布会创建新文章。
   - 如果该笔记已发布过，会提示更新现有文章。

### 4. 管理文章
在 **文章管理** 标签页中，您可以：
- 查看已发布的所有文章状态。
- **更新到 Halo**：将本地笔记的最新修改同步到博客。
- **查看**：直接打开博客文章链接。
- **删除**：仅删除本地关联记录，或检测远程状态。
- **状态同步**：如果文章在 Halo 后台被删除，点击“刷新状态”后，插件会标记该记录为“已删除”，您可以点击“删除记录”来清理垃圾数据。

## 🛠️ 开发者指南

如果您想对本插件进行二次开发或贡献代码，请阅读以下内容。

### 项目结构
```bash
siyuan-halo-publisher/
├── src/
│   ├── adaptors/          # 适配器层，封装 Halo API 调用 (HalowebWebAdaptor.ts)
│   ├── api/               # 基础 API 类
│   ├── utils/             # 工具库 (SiyuanUtils, SlugUtils 等)
│   ├── types/             # TypeScript 类型定义
│   ├── App.vue            # UI 主程序 (Vue 3 + Composition API)
│   └── main.ts            # 入口文件
├── plugin.json            # 思源插件配置文件
├── vite.config.ts         # Vite 构建配置
└── package.json
```

### 开发环境搭建
1. 确保安装了 [Node.js](https://nodejs.org/) (推荐 v16+)。
2. 克隆本项目：
   ```bash
   git clone https://github.com/Sundaydream/siyuan-plugin-halo-publisher.git
   ```
3. 安装依赖：
   ```bash
   npm install
   ```

### 构建与调试
- **开发模式**：
  ```bash
  npm run dev
  ```
- **构建插件**：
  ```bash
  npm run build:plugin
  ```
  构建产物均位于 `dist/` 目录。
  
- **安装到本地思源**：
  将 `dist/` 目录下的内容复制到您的思源笔记插件目录即可。
  您可以在 `vite.config.ts` 中配置 `VITE_SIYUAN_WORKSPACE_PATH` 环境变量，以便使用脚本自动复制（需自行编写或修改脚本）。

### 技术细节
- **前端框架**：Vue 3 + TypeScript + Vite
- **API 通信**：由于跨域限制 (CORS) 和思源环境限制，部分请求可能需要通过思源的代理或特定的 Fetch 配置来完成。核心逻辑位于 `HalowebWebAdaptor.ts`。
- **图片处理**：插件核心难点在于图片转存。代码中实现了正则表达式提取 Markdown 图片、转换为 File 对象并调用 Halo 上传接口的逻辑，同时实现了基于文件名的上传缓存机制。

## 📄 许可证

[MIT License](./LICENSE)